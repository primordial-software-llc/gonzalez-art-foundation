<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Digital Art Gallery</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
    @Scripts.Render("~/bundles/jquery")
    @RenderSection("scripts", required: false)
    
    <script>
        function setCookie(authenticationResponse) {
            var d = new Date(authenticationResponse.expirationDate);
            var expires = "expires=" + d.toUTCString();
            document.cookie = 'token=' + encodeURIComponent(authenticationResponse.token) + ';' + expires + ";path=/";
        }

        function isAuthenticated() {
            return document.cookie &&
                document.cookie.indexOf('token=') > -1;
        }

        function updateAuthenticationForm() {
            if (isAuthenticated()) {
                $('#login-form').hide();
                $('#authenticated-user-form').show();
            } else {
                $('#login-form').show();
                $('#authenticated-user-form').hide();
            }
        }

        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        $(document).ready(function () {

            updateAuthenticationForm();

            $('#login').click(function() {
                var url = '/api/Gallery/token?username=' + $('#username').val() + '&password=' + $('#password').val();

                fetch(url, { mode: 'cors' }).then(function(response) {
                    response
                        .json()
                        .then(function(json) {
                            setCookie(json);
                            updateAuthenticationForm();
                        });
                });
            });
            
            $('#signout').click(function() {
                document.cookie = "token=;expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                updateAuthenticationForm();
            });

        });
    </script>
</head>
<body>
    <div id="main-nav" class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <nav class="navbar navbar-light">
                @Html.ActionLink("Digital Art Gallery", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })
                <ul class="nav">
                    <li class="nav-item">
                        @Html.ActionLink("Home", "Index", "Home", new { area = "" }, new { @class = "nav-link"})
                    </li>
                    <li class="nav-item">
                        @Html.ActionLink("Gallery", "ImageViewer", "Home", new { area = "" }, new { @class = "nav-link" })
                    </li>
                </ul>
            </nav>
            
            <div id="login-form" class="input-form">
                <input id="username" type="text" placeholder="Username" class="form-control"/>
                <input id="password" type="password" placeholder="Password" class="form-control"/>
                <input id="login" type="button" value="Login" class="btn btn-secondary"/>
            </div>

            <div id="authenticated-user-form" class="input-form">
                <input id="signout" type="button" value="Signout" class="btn btn-secondary" />
            </div>
        </div>
    </div>
    <div class="container body-content">
        @RenderBody()
        <hr />
        <footer>
            <p>&copy; @DateTime.Now.Year - Timothy Gonzalez - Digital Art Gallery</p>
            Icons by <a href="http://glyphicons.com/">Glyphicons</a> - <a href="/Images/Glyphicons/license.txt">License</a>
        </footer>
    </div>
</body>
</html>
